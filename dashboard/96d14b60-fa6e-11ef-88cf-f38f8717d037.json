{
  "entityType" : "DASHBOARD",
  "entity" : {
    "assignedCustomers" : [ {
      "customerId" : {
        "entityType" : "CUSTOMER",
        "id" : "8de1ef50-a591-11ef-88cf-f38f8717d037"
      },
      "title" : "Dilmah User 01",
      "public" : false
    } ],
    "configuration" : {
      "description" : "",
      "widgets" : {
        "b41c8f3a-0a8d-0f68-b81c-4bd73deabc8a" : {
          "typeFullFqn" : "system.cards.html_card",
          "type" : "static",
          "sizeX" : 7.5,
          "sizeY" : 3,
          "config" : {
            "datasources" : [ {
              "type" : "static",
              "name" : "function",
              "dataKeys" : [ {
                "name" : "f(x)",
                "type" : "function",
                "label" : "Random",
                "color" : "#2196f3",
                "settings" : { },
                "_hash" : 0.15479322438769105,
                "funcBody" : "var value = prevValue + Math.random() * 100 - 50;\nvar multiplier = Math.pow(10, 2 || 0);\nvar value = Math.round(value * multiplier) / multiplier;\nif (value < -1000) {\n\tvalue = -1000;\n} else if (value > 1000) {\n\tvalue = 1000;\n}\nreturn value;"
              } ]
            } ],
            "timewindow" : {
              "realtime" : {
                "timewindowMs" : 60000
              }
            },
            "showTitle" : false,
            "backgroundColor" : "#000000",
            "color" : "#000000DE",
            "padding" : "8px",
            "settings" : {
              "cardHtml" : "<body>\r\n        <label for=\"language\" class=\"language\">Asset Name:</label>\r\n            <select name=\"asset\" id=\"asset\" class=\"select\">\r\n                    <option value=\"01\" selected>Panel Room</option>\r\n            </select>\r\n            <div class=\"home-icon\">\r\n                <div class=\"home-prop\" id=\"homeTrigger\"></div>\r\n            </div>\r\n            <div class=\"MTBtitle\">Dilmah Warehouse 02 Floor G Historical Energy Average</div>\r\n            <div class=\"formContainer\">\r\n                <div class=\"formGroup\">\r\n                    <label for=\"fromDate\" class=\"from\">From:</label>\r\n                    <input type=\"datetime-local\" id=\"fromDate\" name=\"fromDate\">\r\n                </div>\r\n                <div class=\"formGroup\">\r\n                    <label for=\"toDate\" class=\"to\">To:</label>\r\n                    <input type=\"datetime-local\" id=\"toDate\" name=\"toDate\">\r\n                </div>\r\n                <div class=\"formGroup\">\r\n                    <label for=\"parameter\" class=\"parameter\" onchange=\"addSelectOption()\">Select Parameter:</label>\r\n                    <select id=\"parameter\" name=\"parameter\">\r\n                        <option value=\"\" selected>Select a Parameter</option>\r\n                        <option value=\"voltageN1\">Voltage L-N (A)</option>\r\n                        <option value=\"voltageN2\">Voltage L-N (B)</option>\r\n                        <option value=\"voltageN3\">Voltage L-N (C)</option>\r\n                        <option value=\"voltageL1\">Voltage L-L (A)</option>\r\n                        <option value=\"voltageL2\">Voltage L-L (B)</option>\r\n                        <option value=\"voltageL3\">Voltage L-L (C)</option>\r\n                        <option value=\"current1\">Current A</option>\r\n                        <option value=\"current2\">Current B</option>\r\n                        <option value=\"current3\">Current C</option>\r\n                        <option value=\"actipow1\">Active Power A</option>\r\n                        <option value=\"actipow2\">Active Power B</option>\r\n                        <option value=\"actipow3\">Active Power C</option>\r\n                        <option value=\"apppow1\">Apparent Power A</option>\r\n                        <option value=\"apppow2\">Apparent Power B</option>\r\n                        <option value=\"apppow3\">Apparent Power C</option>\r\n                        <option value=\"apppowT\">Apparent Power Total</option>\r\n                        <option value=\"powerFactor1\">Power Factor A</option>\r\n                        <option value=\"powerFactor2\">Power Factor B</option>\r\n                        <option value=\"powerFactor3\">Power Factor C</option>\r\n                        <option value=\"powerFactorT\">Power Factor Total</option>\r\n                        <option value=\"frequency\">Frequency (Hz)</option>\r\n                        <option value=\"mWh\">Total Active Energy</option>\r\n                        <option value=\"mVarh\">Total Apparent Energy</option>\r\n                    </select>\r\n                </div>\r\n                <div class=\"formGroup\">\r\n                    <div id=\"selectedParameters\" style=\"display: none;\">\r\n                        \r\n                    </div>\r\n                </div>\r\n                <div class=\"formGroup\">\r\n                    <button id=\"updateChart\">Update</button>\r\n                </div>\r\n            </div>\r\n            <div id=\"historicalChart\" class=\"historical-chart\"></div>\r\n            <script src=\"https://cdn.jsdelivr.net/npm/apexcharts\"></script>\r\n            <script src=\"https://code.jquery.com/jquery-3.6.0.min.js\"></script>\r\n            <script>\r\n                document.getElementById('homeTrigger').onclick = function() {\r\n                    window.history.back();\r\n                };\r\n                const parameterSelect = document.getElementById('parameter');\r\n                const selectedParametersDiv = document.getElementById('selectedParameters');\r\n                const MAX_PARAMETERS = 3;\r\n                const asset_name = document.getElementById('asset');\r\n                \r\n                function toggleParameterDropdown() {\r\n                    const selectedValue = asset_name.value;\r\n                    \r\n                    if (selectedValue === \"01\") {\r\n                        parameterSelect.style.display = \"block\";\r\n                    } \r\n                }\r\n                document.getElementById(\"asset\").onchange = function() {\r\n                            toggleParameterDropdown();\r\n                        }\r\n                //parameter multiple selection\r\n                // parameterSelect.addEventListener(\"change\", function () {\r\n                //     const selectedValue = parameterSelect.value;\r\n\r\n                    \r\n                //     if (selectedValue) {\r\n                        \r\n                //         const currentCount = selectedParametersDiv.children.length;\r\n\r\n                        \r\n                //         if (currentCount >= MAX_PARAMETERS) {\r\n                //             alert(`You can select a maximum of ${MAX_PARAMETERS} parameters.`);\r\n                //             return;\r\n                //         }\r\n\r\n                        \r\n                //         selectedParametersDiv.style.display = \"block\";\r\n\r\n                        \r\n                //         const parameterItem = document.createElement(\"div\");\r\n                //         parameterItem.className = \"parameter-item\";\r\n                //         parameterItem.setAttribute(\"data-value\", selectedValue);\r\n                //         parameterItem.textContent = parameterSelect.options[parameterSelect.selectedIndex].text;\r\n\r\n                        \r\n                //         const selectedOption = parameterSelect.options[parameterSelect.selectedIndex];\r\n                //         parameterSelect.remove(parameterSelect.selectedIndex);\r\n\r\n                        \r\n                //         parameterItem.addEventListener(\"click\", function () {\r\n                            \r\n                //             const newOption = document.createElement(\"option\");\r\n                //             newOption.value = selectedValue;\r\n                //             newOption.textContent = parameterItem.textContent;\r\n                //             parameterSelect.appendChild(newOption);\r\n\r\n                            \r\n                //             Array.from(parameterSelect.options)\r\n                //                 .sort((a, b) => a.text.localeCompare(b.text))\r\n                //                 .forEach(option => parameterSelect.appendChild(option));\r\n\r\n                            \r\n                //             parameterItem.remove();\r\n\r\n                            \r\n                //             if (selectedParametersDiv.children.length === 0) {\r\n                //                 selectedParametersDiv.style.display = \"none\";\r\n                //             }\r\n                //         });\r\n\r\n                //         selectedParametersDiv.appendChild(parameterItem);\r\n                //     }\r\n                // });\r\n                const parameters = [\r\n                        parameterSelect\r\n                    ];\r\n                parameters.forEach(parameter => {\r\n                        parameter.addEventListener(\"change\", function () {\r\n                            const selectedValue = parameter.value;\r\n                    \r\n                            if (selectedValue) {\r\n                                const currentCount = selectedParametersDiv.children.length;\r\n                    \r\n                                if (currentCount >= MAX_PARAMETERS) {\r\n                                    alert(`You can select a maximum of ${MAX_PARAMETERS} parameters.`);\r\n                                    return;\r\n                                }\r\n                    \r\n                                selectedParametersDiv.style.display = \"block\";\r\n                    \r\n                                const parameterItem = document.createElement(\"div\");\r\n                                parameterItem.className = \"parameter-item\";\r\n                                parameterItem.setAttribute(\"data-value\", selectedValue);\r\n                                parameterItem.textContent = parameter.options[parameter.selectedIndex].text;\r\n                    \r\n                                const originalIndex = parameter.selectedIndex;\r\n                    \r\n                                const selectedOption = parameter.options[parameter.selectedIndex];\r\n                                parameter.remove(parameter.selectedIndex);\r\n                    \r\n                                parameterItem.addEventListener(\"click\", function () {\r\n                                    const newOption = document.createElement(\"option\");\r\n                                    newOption.value = selectedValue;\r\n                                    newOption.textContent = parameterItem.textContent;\r\n                    \r\n                                    parameter.add(newOption, originalIndex);\r\n                                    parameterItem.remove();\r\n                    \r\n                                    if (selectedParametersDiv.children.length === 0) {\r\n                                        selectedParametersDiv.style.display = \"none\";\r\n                                    }\r\n                                });\r\n                    \r\n                                selectedParametersDiv.appendChild(parameterItem);\r\n                            }\r\n                        });\r\n                    });\r\n                \r\n                //update button trigger\r\n                document.getElementById('updateChart').addEventListener('click', async () => {\r\n                            const selectedParametersDiv = document.getElementById('historicalChart');\r\n                            selectedParametersDiv.style.display = 'flex';\r\n                            selectedParametersDiv.innerHTML = `\r\n                                <div style=\"display: flex; justify-content: center; align-items: center; width: 100%;\">\r\n                                    <div style=\"\r\n                                        border: 4px solid #f3f3f3;\r\n                                        border-top: 4px solid #007bff;\r\n                                        border-radius: 50%;\r\n                                        width: 40px;\r\n                                        height: 40px;\r\n                                        animation: spin 1s linear infinite;\r\n                                    \"></div>\r\n                                </div>\r\n                            `;\r\n                                const updateButton = document.getElementById('updateChart');\r\n                                updateButton.disabled = true;\r\n                                updateButton.style.opacity = '0.5';\r\n                                updateButton.textContent = 'Updating...';\r\n                                try {\r\n                                        const fromDate = document.getElementById('fromDate').value;\r\n                                        const toDate = document.getElementById('toDate').value;\r\n                                        console.log('From Date :',new Date(fromDate).getTime());\r\n                                        console.log('To Date Date :',new Date(toDate).getTime());\r\n                                        const selectedParametersPar = [...document.querySelectorAll('.parameter-item')].map(item => item.getAttribute('data-value'));\r\n                            \r\n                                        if (!fromDate || !toDate) {\r\n                                            alert(\"Please select both 'From' and 'To' dates.\");\r\n                                            return;\r\n                                        }\r\n                            \r\n                                        const token = await getJwtToken();\r\n                                        if (token) {\r\n                                            let apiToken = 0;\r\n                                            let asset_selection = document.getElementById('asset').value;\r\n                                            console.log(\"Asset ID :\", asset_selection);\r\n                                            var unitMappingPar;\r\n                                            var key_par;\r\n                                            if (asset_selection == \"01\") {\r\n                                                apiToken = '3d911780-a58f-11ef-88cf-f38f8717d037';\r\n                                                unitMappingPar = {\r\n                                                        voltageN1: { key: 'M01', unit: 'V', name: 'Voltage L-N (A)'},\r\n                                                        voltageN2: { key: 'M02', unit: 'V', name: 'Voltage L-N (B)'},\r\n                                                        voltageN3: { key: 'M03', unit: 'V', name: 'Voltage L-N (C)'},\r\n                                                        voltageL1: { key: 'M04', unit: 'V', name: 'Voltage L-L (A)'},\r\n                                                        voltageL2: { key: 'M05', unit: 'V', name: 'Voltage L-L (B)'},\r\n                                                        voltageL3: { key: 'M06', unit: 'V', name: 'Voltage L-L (C)'},\r\n                                                        current1: { key: 'M07', unit: 'A', name: 'Current A'},\r\n                                                        current2: { key: 'M08', unit: 'A', name: 'Current B'},\r\n                                                        current3: { key: 'M09', unit: 'A', name: 'Current C'},\r\n                                                        actipow1: { key: 'M10', unit: 'kW', name: 'Active Power A'},\r\n                                                        actipow2: { key: 'M11', unit: 'kW', name: 'Active Power B'},\r\n                                                        actipow3: { key: 'M12', unit: 'kW', name: 'Active Power C'},\r\n                                                        apppow1: { key: 'M13', unit: 'kVA', name: 'Apparent Power A'},\r\n                                                        apppow2: { key: 'M14', unit: 'kVA', name: 'Apparent Power B'},\r\n                                                        apppow3: { key: 'M15', unit: 'kVA', name: 'Apparent Power C'},\r\n                                                        apppowT: { key: null, unit: 'kVA', name: 'Apparent Power Total'},\r\n                                                        powerFactor1: { key: 'M16', unit: '', name: 'Power Factor A'},\r\n                                                        powerFactor2: { key: 'M17', unit: '', name: 'Power Factor B'},\r\n                                                        powerFactor3: { key: 'M18', unit: '', name: 'Power Factor C'},\r\n                                                        powerFactorT: { key: 'M19', unit: '', name: 'Power Factor Total'},\r\n                                                        frequency: { key: 'M20', unit: 'Hz', name: 'Frequency'},\r\n                                                        mWh: { key: 'M21', unit: 'kWh', name: 'Active Energy'},\r\n                                                        mVarh: { key: 'M22', unit: 'kVArh', name: 'Apparent Energy'},\r\n                                                };\r\n                                            }\r\n                                            // else if (asset_selection == \"03\") {\r\n                                            //     apiToken = 'c1c30fa0-a58e-11ef-88cf-f38f8717d037';\r\n                                            // }\r\n                                            // else if (asset_selection == \"04\") {\r\n                                            //     apiToken = 'c1c30fa0-a58e-11ef-88cf-f38f8717d037';\r\n                                            // }\r\n                                            // else if (asset_selection == \"05\") {\r\n                                            //     apiToken = 'cf6645a0-a58e-11ef-88cf-f38f8717d037';\r\n                                            // }\r\n                                            console.log('Asset Number is :', asset_selection);\r\n                                            console.log('API TOKEN is :', apiToken);\r\n                                            let selectedParamsLimited = selectedParametersPar.slice(0, 3);\r\n                                            key_par = selectedParamsLimited\r\n                                                .map(param => unitMappingPar[param]?.key)\r\n                                                .filter(key => key != null) \r\n                                                .join(',');\r\n                                            const telemetryData = await fetchTelemetryData(token, fromDate, toDate, apiToken, key_par);\r\n                                            displayChartAndMonthlyAvg(telemetryData);\r\n                                        }\r\n                                } catch (error) {\r\n                                    console.error('Error updating chart:', error);\r\n                                    \r\n                                    // Clear loader and show error\r\n                                    selectedParametersDiv.innerHTML = `\r\n                                        <div style=\"color: red; text-align: center; width: 100%;\">\r\n                                            Error updating chart. Please try again.\r\n                                        </div>\r\n                                    `;\r\n                                } finally {\r\n                                    // Re-enable update button\r\n                                    updateButton.disabled = false;\r\n                                    updateButton.style.opacity = '1';\r\n                                    updateButton.textContent = 'Update';\r\n                                }\r\n                });\r\n                \r\n                //user credential grant\r\n                async function getJwtToken() {\r\n                    const loginUrl = 'https://energy-app.utech-iiot.lk/api/auth/login';\r\n                    const credentials = { username: 'dilmah@gmail.com', password: 'Dilmah@2024' };\r\n                    try {\r\n                        const response = await fetch(loginUrl, {\r\n                            method: 'POST',\r\n                            headers: { 'Content-Type': 'application/json' },\r\n                            body: JSON.stringify(credentials)\r\n                        });\r\n                        const data = await response.json();\r\n                        return data.token;\r\n                    } catch (error) {\r\n                        console.error('Login error:', error);\r\n                    }\r\n                }\r\n                \r\n                //data retrieval\r\n                async function fetchTelemetryData(token, fromDate, toDate, assetID, key) {\r\n                    const apiUrl = `https://energy-app.utech-iiot.lk/api/plugins/telemetry/DEVICE/${assetID}/values/timeseries?keys=${key}&startTs=${new Date(fromDate).getTime()}&endTs=${new Date(toDate).getTime()}&limit=90000`;\r\n                    try {\r\n                        const response = await fetch(apiUrl, {\r\n                            method: 'GET',\r\n                            headers: { 'Authorization': `Bearer ${token}` }\r\n                        });\r\n                        return await response.json();\r\n                    } catch (error) {\r\n                        console.error('Error fetching telemetry data:', error);\r\n                    }\r\n                }\r\n                \r\n                //data format\r\n                function displayChartAndMonthlyAvg(data) {\r\n                    // let totalUnits = 0;\r\n                    // let seriesData = [];\r\n                    // let monthlyMaxValues = {};\r\n                    // let names;\r\n                    // let unit;\r\n                    const selectedParameters = [...document.querySelectorAll('.parameter-item')].map(item => item.getAttribute('data-value'));\r\n                    let seriesData = {};\r\n                    let unitMapping = {};\r\n                    let asset_selection = document.getElementById('asset').value;\r\n                    if (asset_selection == \"01\" ) {\r\n                            unitMapping = {\r\n                                voltageN1: { key: 'M01', unit: 'V', name: 'Voltage L-N (A)' },\r\n                                voltageN2: { key: 'M02', unit: 'V', name: 'Voltage L-N (B)' },\r\n                                voltageN3: { key: 'M03', unit: 'V', name: 'Voltage L-N (C)' },\r\n                                voltageL1: { key: 'M04', unit: 'V', name: 'Voltage L-L (A)' },\r\n                                voltageL2: { key: 'M05', unit: 'V', name: 'Voltage L-L (B)' },\r\n                                voltageL3: { key: 'M06', unit: 'V', name: 'Voltage L-L (C)' },\r\n                                current1: { key: 'M07', unit: 'A', name: 'Current A' },\r\n                                current2: { key: 'M08', unit: 'A', name: 'Current B' },\r\n                                current3: { key: 'M09', unit: 'A', name: 'Current C' },\r\n                                actipow1: { key: 'M10', unit: 'kW', name: 'Active Power A' },\r\n                                actipow2: { key: 'M11', unit: 'kW', name: 'Active Power B' },\r\n                                actipow3: { key: 'M12', unit: 'kW', name: 'Active Power C' },\r\n                                apppow1: { key: 'M13', unit: 'kVA', name: 'Apparent Power A' },\r\n                                apppow2: { key: 'M14', unit: 'kVA', name: 'Apparent Power B' },\r\n                                apppow3: { key: 'M15', unit: 'kVA', name: 'Apparent Power C' },\r\n                                apppowT: { key: null, unit: 'kVA', name: 'Apparent Power Total' },\r\n                                powerFactor1: { key: 'M16', unit: '', name: 'Power Factor A' },\r\n                                powerFactor2: { key: 'M17', unit: '', name: 'Power Factor B' },\r\n                                powerFactor3: { key: 'M18', unit: '', name: 'Power Factor C' },\r\n                                powerFactorT: { key: 'M19', unit: '', name: 'Power Factor Total' },\r\n                                frequency: { key: 'M20', unit: 'Hz', name: 'Frequency' },\r\n                                mWh: { key: 'M21', unit: 'kWh', name: 'Active Energy' },\r\n                                mVarh: { key: 'M22', unit: 'kVArh', name: 'Apparent Energy' },\r\n                            };\r\n                    } \r\n                    // } else if(asset_selection == \"03\") {\r\n                    //     unitMapping = {\r\n                    //             voltageN1: { key: 'M01', unit: 'V', name: 'Voltage L-N (A)' },\r\n                    //             voltageN2: { key: 'M02', unit: 'V', name: 'Voltage L-N (B)' },\r\n                    //             voltageN3: { key: 'M03', unit: 'V', name: 'Voltage L-N (C)' },\r\n                    //             voltageL1: { key: 'M04', unit: 'V', name: 'Voltage L-L (A)' },\r\n                    //             voltageL2: { key: 'M05', unit: 'V', name: 'Voltage L-L (B)' },\r\n                    //             voltageL3: { key: 'M06', unit: 'V', name: 'Voltage L-L (C)' },\r\n                    //             current1: { key: 'M07', unit: 'A', name: 'Current A' },\r\n                    //             current2: { key: 'M08', unit: 'A', name: 'Current B' },\r\n                    //             current3: { key: 'M09', unit: 'A', name: 'Current C' },\r\n                    //             actipow1: { key: 'M10', unit: 'kW', name: 'Active Power A' },\r\n                    //             actipow2: { key: 'M11', unit: 'kW', name: 'Active Power B' },\r\n                    //             actipow3: { key: 'M12', unit: 'kW', name: 'Active Power C' },\r\n                    //             apppow1: { key: 'M13', unit: 'kVA', name: 'Apparent Power A' },\r\n                    //             apppow2: { key: 'M14', unit: 'kVA', name: 'Apparent Power B' },\r\n                    //             apppow3: { key: 'M15', unit: 'kVA', name: 'Apparent Power C' },\r\n                    //             powerFactor1: { key: 'M16', unit: '', name: 'Power Factor A' },\r\n                    //             powerFactor2: { key: 'M17', unit: '', name: 'Power Factor B' },\r\n                    //             powerFactor3: { key: 'M18', unit: '', name: 'Power Factor C' },\r\n                    //             frequency: { key: 'M20', unit: 'Hz', name: 'Frequency' },\r\n                    //             mWh: { key: 'M21', unit: 'kWh', name: 'Active Energy' },\r\n                    //             mVarh: { key: 'M22', unit: 'kVArh', name: 'Apparent Energy' },\r\n                    //     };\r\n                    // } else if(asset_selection == \"04\") {\r\n                    //     unitMapping = {\r\n                    //             voltageN1: { key: 'M31', unit: 'V', name: 'Voltage L-N (A)' },\r\n                    //             voltageN2: { key: 'M32', unit: 'V', name: 'Voltage L-N (B)' },\r\n                    //             voltageN3: { key: 'M33', unit: 'V', name: 'Voltage L-N (C)' },\r\n                    //             voltageL1: { key: 'M34', unit: 'V', name: 'Voltage L-L (A)' },\r\n                    //             voltageL2: { key: 'M35', unit: 'V', name: 'Voltage L-L (B)' },\r\n                    //             voltageL3: { key: 'M36', unit: 'V', name: 'Voltage L-L (C)' },\r\n                    //             current1: { key: 'M37', unit: 'A', name: 'Current A' },\r\n                    //             current2: { key: 'M38', unit: 'A', name: 'Current B' },\r\n                    //             current3: { key: 'M39', unit: 'A', name: 'Current C' },\r\n                    //             actipow1: { key: 'M40', unit: 'kW', name: 'Active Power A' },\r\n                    //             actipow2: { key: 'M41', unit: 'kW', name: 'Active Power B' },\r\n                    //             actipow3: { key: 'M42', unit: 'kW', name: 'Active Power C' },\r\n                    //             apppow1: { key: 'M43', unit: 'kVA', name: 'Apparent Power A' },\r\n                    //             apppow2: { key: 'M44', unit: 'kVA', name: 'Apparent Power B' },\r\n                    //             apppow3: { key: 'M45', unit: 'kVA', name: 'Apparent Power C' },\r\n                    //             powerFactor1: { key: 'M46', unit: '', name: 'Power Factor A' },\r\n                    //             powerFactor2: { key: 'M47', unit: '', name: 'Power Factor B' },\r\n                    //             powerFactor3: { key: 'M48', unit: '', name: 'Power Factor C' },\r\n                    //             frequency: { key: 'M50', unit: 'Hz', name: 'Frequency' },\r\n                    //             mWh: { key: 'M51', unit: 'kWh', name: 'Active Energy' },\r\n                    //             mVarh: { key: 'M52', unit: 'kVArh', name: 'Apparent Energy' },\r\n                    //     };\r\n                    // } else if(asset_selection == \"05\") {\r\n                    //     unitMapping = {\r\n                    //             voltageN1: { key: 'M01', unit: 'V', name: 'Voltage L-N (A)' },\r\n                    //             voltageN2: { key: 'M02', unit: 'V', name: 'Voltage L-N (B)' },\r\n                    //             voltageN3: { key: 'M03', unit: 'V', name: 'Voltage L-N (C)' },\r\n                    //             voltageL1: { key: 'M04', unit: 'V', name: 'Voltage L-L (A)' },\r\n                    //             voltageL2: { key: 'M05', unit: 'V', name: 'Voltage L-L (B)' },\r\n                    //             voltageL3: { key: 'M06', unit: 'V', name: 'Voltage L-L (C)' },\r\n                    //             current1: { key: 'M07', unit: 'A', name: 'Current A' },\r\n                    //             current2: { key: 'M08', unit: 'A', name: 'Current B' },\r\n                    //             current3: { key: 'M09', unit: 'A', name: 'Current C' },\r\n                    //             actipow1: { key: 'M10', unit: 'kW', name: 'Active Power A' },\r\n                    //             actipow2: { key: 'M11', unit: 'kW', name: 'Active Power B' },\r\n                    //             actipow3: { key: 'M12', unit: 'kW', name: 'Active Power C' },\r\n                    //             apppow1: { key: 'M13', unit: 'kVA', name: 'Apparent Power A' },\r\n                    //             apppow2: { key: 'M14', unit: 'kVA', name: 'Apparent Power B' },\r\n                    //             apppow3: { key: 'M15', unit: 'kVA', name: 'Apparent Power C' },\r\n                    //             powerFactor1: { key: 'M16', unit: '', name: 'Power Factor A' },\r\n                    //             powerFactor2: { key: 'M17', unit: '', name: 'Power Factor B' },\r\n                    //             powerFactor3: { key: 'M18', unit: '', name: 'Power Factor C' },\r\n                    //             frequency: { key: 'M20', unit: 'Hz', name: 'Frequency' },\r\n                    //             mWh: { key: 'M21', unit: 'kWh', name: 'Active Energy' },\r\n                    //             mVarh: { key: 'M22', unit: 'kVArh', name: 'Apparent Energy' },\r\n                    //     };\r\n                    \r\n                    //const dataPoints = data?.data || [];\r\n                    selectedParameters.forEach(parameter => {\r\n                        const { key, unit, name } = unitMapping[parameter] || {};\r\n                        if (!seriesData[parameter]) {\r\n                            seriesData[parameter] = { name, unit, data: [] };\r\n                        }\r\n                    \r\n                        if (parameter === 'apppowT') {\r\n                            const keys = ['M13', 'M14', 'M15'];\r\n                            const length = Math.min(\r\n                                data['M13']?.length || 0,\r\n                                data['M14']?.length || 0,\r\n                                data['M15']?.length || 0\r\n                            );\r\n                    \r\n                            for (let i = 0; i < length; i++) {\r\n                                const val1 = parseFloat(data['M13'][i]?.value) || 0;\r\n                                const val2 = parseFloat(data['M14'][i]?.value) || 0;\r\n                                const val3 = parseFloat(data['M15'][i]?.value) || 0;\r\n                                const ts = data['M13'][i]?.ts || null;\r\n                    \r\n                                if (ts !== null) {\r\n                                    seriesData[parameter].data.push({\r\n                                        x: ts,\r\n                                        y: (val1 + val2 + val3).toFixed(2)\r\n                                    });\r\n                                }\r\n                            }\r\n                        } else if (key && data[key]) {\r\n                            data[key].forEach(point => {\r\n                                if (point && point.value !== \"-nan\" && !isNaN(point.value)) {\r\n                                    seriesData[parameter].data.push({\r\n                                        x: point.ts,\r\n                                        y: parseFloat(point.value).toFixed(2)\r\n                                    });\r\n                                }\r\n                            });\r\n                        }\r\n                    });\r\n                    // data.data.forEach(dataPoint => {\r\n                    //     const json_form = JSON.parse(dataPoint.value);\r\n                    //     selectedParameters.forEach(parameter => {\r\n                    //         const { key, unit, name } = unitMapping[parameter] || {};\r\n                    //         if (!seriesData[parameter]) {\r\n                    //             seriesData[parameter] = { name, unit, data: [] };\r\n                    //         }\r\n                    //         if (parameter === \"apppowT\") {\r\n                               \r\n                    //             let totalPower = 0;\r\n                    //             const keys = [\"M73\", \"M74\", \"M75\"];\r\n                    \r\n                    //             keys.forEach(k => {\r\n                    //                 if (json_form[k] !== undefined && !isNaN(json_form[k])) {\r\n                    //                     totalPower += parseFloat(json_form[k]);\r\n                    //                 }\r\n                    //             });\r\n                    \r\n                    //             seriesData[parameter].data.push({\r\n                    //                 x: new Date(dataPoint.ts).getTime(),\r\n                    //                 y: totalPower.toFixed(2) \r\n                    //             });\r\n                    //         } else if (key && json_form[key] !== undefined) {\r\n                    //             seriesData[parameter].data.push({\r\n                    //                 x: new Date(dataPoint.ts).getTime(),\r\n                    //                 y: parseFloat(json_form[key]).toFixed(2)\r\n                    //             });\r\n                    //         }\r\n                    //     });\r\n                    // });\r\n                    console.log(\"Series data for chart:\", seriesData);\r\n                    const selectedParametersDiv = document.getElementById('historicalChart');\r\n                    selectedParametersDiv.innerHTML = '';\r\n                    renderChart(seriesData);\r\n                }\r\n                //Apexcharts start point\r\n                function renderChart(seriesData) {\r\n                    if (window.historicalChart) {\r\n                        if (typeof window.historicalChart.destroy === 'function') {\r\n                            //console.log('Destroying existing chart...');\r\n                            window.historicalChart.destroy();\r\n                        } else {\r\n                            console.log('historicalChart found, but destroy method not available');\r\n                        }\r\n                    } else {\r\n                        console.log('No existing chart to destroy.');\r\n                    }\r\n\r\n                    const seriesArray = Object.values(seriesData).map(series => ({\r\n                        name: series.name,\r\n                        unit: series.unit,\r\n                        data: series.data\r\n                    }));\r\n                    console.log(\"Series Array is :\", seriesArray);\r\n\r\n                    const options = {\r\n                        chart: {\r\n                            type: 'line',\r\n                            height: 680,\r\n                            foreColor: '#ffffff',\r\n                            toolbar: { tools: { download: true } }\r\n                        },\r\n                        series: seriesArray,\r\n                        xaxis: { type: 'datetime', title: { text: 'Time' }, \r\n                        labels: {\r\n                            formatter: function (val) {\r\n                                \r\n                                const date = new Date(val);\r\n                                const offsetMilliseconds = 5.5 * 60 * 60 * 1000; \r\n                                const localDate = new Date(date.getTime() + offsetMilliseconds);\r\n                                return localDate.toLocaleString('en-GB', { \r\n                                    timeZone: 'UTC', \r\n                                    hour12: false \r\n                                }).replace(',', ''); \r\n                            }\r\n                        }},\r\n                        yaxis: { title: { text: 'Values' } },\r\n                        tooltip: {\r\n                            x: {\r\n                                formatter: function (val) {\r\n                                    \r\n                                    const date = new Date(val);\r\n                                    const offsetMilliseconds = 5.5 * 60 * 60 * 1000; \r\n                                    const localDate = new Date(date.getTime() + offsetMilliseconds);\r\n                                    return localDate.toLocaleString('en-GB', { \r\n                                        timeZone: 'UTC', \r\n                                        hour12: false \r\n                                    }).replace(',', ''); \r\n                                }\r\n                            },\r\n                            y: { formatter: function (val, { seriesIndex }) {\r\n                                \r\n                                const unit = seriesArray[seriesIndex]?.unit || '';\r\n                                return `${val} ${unit}`; }\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    window.historicalChart = new ApexCharts(document.querySelector(\"#historicalChart\"), options);\r\n                    window.historicalChart.render();\r\n                }\r\n                // function renderChart(seriesData, names, unit) {\r\n                //     let avgLineValue = 12;\r\n                //     if (window.historicalChart) {\r\n                //         if (typeof window.historicalChart.destroy === 'function') {\r\n                //             //console.log('Destroying existing chart...');\r\n                //             window.historicalChart.destroy();\r\n                //         } else {\r\n                //             console.log('historicalChart found, but destroy method not available');\r\n                //         }\r\n                //     } else {\r\n                //         console.log('No existing chart to destroy.');\r\n                //     }\r\n        \r\n                //     const options = {\r\n                //         chart: {\r\n                //             type: 'line',\r\n                //             height: 680,\r\n                //             foreColor: '#ffffff',\r\n                //             toolbar: {\r\n                //                 tools: {\r\n                //                     download: true \r\n                //                 },\r\n                //                 autoSelected: 'pan' \r\n                //             },\r\n                //             events: {\r\n                //                 beforeDownload: function({ dataURI, options }) {\r\n                                    \r\n                //                     const fromDate = document.getElementById(\"fromDate\").value || \"start\";\r\n                //                     const toDate = document.getElementById(\"toDate\").value || \"end\";\r\n                                    \r\n                                    \r\n                //                     const cleanFromDate = fromDate.replace(/[:T]/g, \"-\");\r\n                //                     const cleanToDate = toDate.replace(/[:T]/g, \"-\");\r\n                \r\n                                    \r\n                //                     const fileName = `historical_energy_${cleanFromDate}_to_${cleanToDate}`;\r\n                //                     options.chart.toolbar.download.filename = fileName;\r\n                //                 }\r\n                //             }\r\n                //         },\r\n                //         series: [ {\r\n                //                 name: names,\r\n                //                 data: seriesData\r\n                //             }],\r\n                //         xaxis: {\r\n                //             type: 'datetime',\r\n                //             title: { text: 'Time' }\r\n                //         },\r\n                //         yaxis: {\r\n                //             title: { text: names }\r\n                //         },\r\n                //         title: {\r\n                //             text: 'Historical Graph',\r\n                //             align: 'center'\r\n                //         },\r\n                //         tooltip: {\r\n                //             x: { format: 'dd MMM yyyy HH:mm' },\r\n                //             y: { formatter: (val) => `${val} ${unit}` }\r\n                //         },\r\n                //         annotations: {\r\n                //         // yaxis: [{\r\n                //         //     y: avgLineValue,\r\n                //         //     borderColor: '#FF5733',\r\n                //         //     label: {\r\n                //         //         borderColor: '#FF5733',\r\n                //         //         style: {\r\n                //         //             color: '#fff',\r\n                //         //             background: '#FF5733'\r\n                //         //         },\r\n                //         //         text: `Average: ${avgLineValue} kWh`\r\n                //         //     }\r\n                //         // }]\r\n                //     }\r\n                //     };\r\n        \r\n                //     window.historicalChart = new ApexCharts(document.querySelector(\"#historicalChart\"), options);\r\n                //     window.historicalChart.render();\r\n                // }\r\n                //renderChart();\r\n                \r\n                //urlid check\r\n                const urlParams = new URLSearchParams(window.location.search);\r\n                const assetValue = urlParams.get('asset');\r\n            \r\n                \r\n                if (assetValue) {\r\n                    const dropdown = document.getElementById('asset');\r\n                    dropdown.value = assetValue;\r\n                }\r\n                \r\n                \r\n                //parameter freeze   \r\n                function addSelectOption() {\r\n                    const select = document.getElementById('parameter');\r\n                    const selectedValue = select.value; \r\n                    const selectedText = select.options[select.selectedIndex].text; \r\n                    \r\n                    \r\n                    const defaultOption = `<option value=\"\" selected>Select a Parameter</option>`;\r\n                    const additionalOptions = `\r\n                        <option value=\"\" selected>Select a Parameter</option>\r\n                        <option value=\"voltageN1\">Voltage L-N (A)</option>\r\n                        <option value=\"voltageN2\">Voltage L-N (B)</option>\r\n                        <option value=\"voltageN3\">Voltage L-N (C)</option>\r\n                        <option value=\"voltageL1\">Voltage L-L (A)</option>\r\n                        <option value=\"voltageL2\">Voltage L-L (B)</option>\r\n                        <option value=\"voltageL3\">Voltage L-L (C)</option>\r\n                        <option value=\"current1\">Current A</option>\r\n                        <option value=\"current2\">Current B</option>\r\n                        <option value=\"current3\">Current C</option>\r\n                        <option value=\"actipow1\">Active Power A</option>\r\n                        <option value=\"actipow2\">Active Power B</option>\r\n                        <option value=\"actipow3\">Active Power C</option>\r\n                        <option value=\"apppow1\">Apparent Power A</option>\r\n                        <option value=\"apppow2\">Apparent Power B</option>\r\n                        <option value=\"apppow3\">Apparent Power C</option>\r\n                        <option value=\"powerFactor1\">Power Factor A</option>\r\n                        <option value=\"powerFactor2\">Power Factor B</option>\r\n                        <option value=\"powerFactor3\">Power Factor C</option>\r\n                        <option value=\"frequency\">Frequency (Hz)</option>\r\n                        <option value=\"mWh\">Total Active Energy</option>\r\n                        <option value=\"mVarh\">Total Apparent Energy</option>\r\n                    `;\r\n\r\n                    \r\n                    const selectedOption = `<option value=\"${selectedValue}\" selected>${selectedText} (Selected)</option>`;\r\n\r\n                    \r\n                    select.innerHTML = defaultOption + selectedOption + additionalOptions;\r\n                }\r\n            </script>\r\n        </body>",
              "cardCss" : "  \r\n            body {\r\n            font-family: Arial, sans-serif;\r\n            background-color: #000000;\r\n            color: #000000;\r\n        }\r\n        \r\n        .language, .from, .to, .parameter {\r\n            color : white;\r\n            \r\n        }\r\n        .formContainer {\r\n            display: flex;\r\n            justify-content: space-between;\r\n            gap: 20px;\r\n            margin-bottom: 20px;\r\n            align-items: center;\r\n        }\r\n        .formGroup {\r\n            display: flex;\r\n            flex-direction: column;\r\n            width: 20%;\r\n        }\r\n        .formGroup label {\r\n            margin-bottom: 5px;\r\n            font-weight: bold;\r\n        }\r\n        .formGroup input, .formGroup select {\r\n            padding: 10px;\r\n            border-radius: 6px;\r\n            border: 1px solid #575757;\r\n            font-size: 15px;\r\n            width: 100%;\r\n            background-color: #2e2e2e;\r\n            color: #ffffff;\r\n        }\r\n        .formGroup #selectedParameters {\r\n            margin-top: 10px;\r\n            padding: 10px;\r\n            border: 1px solid #575757;\r\n            border-radius: 6px;\r\n            background-color: #1a1a1a;\r\n            color: #ffffff;\r\n            font-size: 14px;\r\n            min-height: 50px;\r\n        }\r\n        .home-icon {\r\n            display: flex;\r\n            margin-top: 3px;\r\n            justify-content: left;\r\n        }\r\n        \r\n        .home-prop {\r\n            height: 50px;\r\n            width: 50px;\r\n            margin-top: 20px;\r\n            cursor: pointer;\r\n            border-radius: 25px;\r\n            /* Add an icon as the background image */\r\n            background-image: url('https://energy-app.utech-iiot.lk/api/images/public/CT4OWEPgqkOvL4MeDMGyfT8HJlz2LP5U');\r\n            /* Replace 'icon.png' with your icon's path */\r\n            background-size: cover;\r\n            /* Resize the image to cover the div */\r\n            background-repeat: no-repeat;\r\n            background-position: center;\r\n            /* Center the icon inside the div */\r\n        }\r\n        .parameter-item {\r\n            display: inline-block;\r\n            margin: 5px;\r\n            padding: 5px 10px;\r\n            border-radius: 15px;\r\n            background-color: #133df7;\r\n            color: white;\r\n            font-size: 14px;\r\n            cursor: pointer;\r\n        }\r\n        .parameter-item:hover {\r\n            background-color: #c71919;\r\n        }\r\n        /* .formGroup select {\r\n            padding: 10px;\r\n            border-radius: 6px;\r\n            border: 1px solid #575757;\r\n            font-size: 15px;\r\n            width: 100%;\r\n            background-color: #2e2e2e;\r\n            color: #ffffff;\r\n            height: 150px;\r\n        } */\r\n        .formGroup button {\r\n            padding: 12px;\r\n            background-color: #007bff;\r\n            color: white;\r\n            border: none;\r\n            border-radius: 6px;\r\n            cursor: pointer;\r\n            font-size: 15px;\r\n        }\r\n        .formGroup button:hover {\r\n            background-color: #0056b3;\r\n        }\r\n        .historical-chart {\r\n            margin-top: 25px;\r\n            width: 100%;\r\n            height: 700px;\r\n        }\r\n        .MTBtitle {\r\n            font-size: 22px;\r\n            font-weight: bold;\r\n            text-align: center;\r\n            margin-bottom: 20px;\r\n            color: #00e6a3;\r\n        }\r\n        #monthlyAverage {\r\n            text-align: center;\r\n            font-size: 18px;\r\n            margin-top: 20px;\r\n            color: #00e6a3;\r\n        }\r\n        #historicalChart {\r\n            height: 200px;\r\n            background-color: #333644;\r\n            border-radius: 10px;\r\n            padding: 20px;\r\n            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);\r\n        }\r\n        @keyframes spin {\r\n            0% { transform: rotate(0deg); }\r\n            100% { transform: rotate(360deg); }\r\n        }"
            },
            "title" : "HTML Card",
            "dropShadow" : true,
            "enableFullscreen" : true,
            "widgetStyle" : { },
            "widgetCss" : "",
            "pageSize" : 1024,
            "noDataDisplayMessage" : ""
          },
          "row" : 0,
          "col" : 0,
          "id" : "b41c8f3a-0a8d-0f68-b81c-4bd73deabc8a"
        }
      },
      "states" : {
        "default" : {
          "name" : "Dilmah Warehouse 02 Floor G Graphs",
          "root" : true,
          "layouts" : {
            "main" : {
              "widgets" : {
                "b41c8f3a-0a8d-0f68-b81c-4bd73deabc8a" : {
                  "sizeX" : 31,
                  "sizeY" : 19,
                  "row" : 0,
                  "col" : 0
                }
              },
              "gridSettings" : {
                "backgroundColor" : "#eeeeee",
                "columns" : 24,
                "margin" : 10,
                "outerMargin" : true,
                "backgroundSizeMode" : "100%"
              }
            }
          }
        }
      },
      "entityAliases" : { },
      "filters" : { },
      "timewindow" : {
        "displayValue" : "",
        "hideInterval" : false,
        "hideLastInterval" : false,
        "hideQuickInterval" : false,
        "hideAggregation" : false,
        "hideAggInterval" : false,
        "hideTimezone" : false,
        "selectedTab" : 0,
        "realtime" : {
          "realtimeType" : 0,
          "interval" : 1000,
          "timewindowMs" : 60000,
          "quickInterval" : "CURRENT_DAY"
        },
        "history" : {
          "historyType" : 0,
          "interval" : 1000,
          "timewindowMs" : 60000,
          "fixedTimewindow" : {
            "startTimeMs" : 1736244216507,
            "endTimeMs" : 1736330616507
          },
          "quickInterval" : "CURRENT_DAY"
        },
        "aggregation" : {
          "type" : "AVG",
          "limit" : 25000
        }
      },
      "settings" : {
        "stateControllerId" : "entity",
        "showTitle" : false,
        "showDashboardsSelect" : true,
        "showEntitiesSelect" : true,
        "showDashboardTimewindow" : true,
        "showDashboardExport" : true,
        "toolbarAlwaysOpen" : true
      }
    },
    "externalId" : null,
    "id" : {
      "entityType" : "DASHBOARD",
      "id" : "96d14b60-fa6e-11ef-88cf-f38f8717d037"
    },
    "image" : null,
    "mobileHide" : false,
    "mobileOrder" : null,
    "name" : "Dilmah Warehouse 02 Floor G Graphs",
    "title" : "Dilmah Warehouse 02 Floor G Graphs"
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}